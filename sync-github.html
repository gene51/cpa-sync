<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CPAåˆ·é¢˜åŠ©æ‰‹ - GitHubåŒæ­¥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 32px 24px;
      text-align: center;
    }
    
    .header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .header p {
      margin: 0;
      opacity: 0.9;
      font-size: 16px;
    }
    
    .content {
      padding: 32px 24px;
    }
    
    .section {
      margin-bottom: 32px;
    }
    
    .section:last-child {
      margin-bottom: 0;
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.2s;
      background: white;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .btn {
      padding: 16px 20px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
    }
    
    .btn-secondary {
      background: #f8fafc;
      color: #1e293b;
      border: 2px solid #e2e8f0;
    }
    
    .btn-secondary:hover {
      background: #e2e8f0;
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: white;
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(74, 222, 128, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
      color: white;
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(248, 113, 113, 0.4);
    }
    
    .info-box {
      background: #fef3c7;
      border: 2px solid #fde68a;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .info-box h4 {
      color: #92400e;
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
    }
    
    .info-box p {
      color: #92400e;
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .status-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #e2e8f0;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .status-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    
    .status-label {
      font-weight: 500;
      color: #64748b;
    }
    
    .status-value {
      font-weight: 600;
      color: #1e293b;
    }
    
    .status-value.success {
      color: #22c55e;
    }
    
    .status-value.warning {
      color: #f59e0b;
    }
    
    .status-value.error {
      color: #ef4444;
    }
    
    .message {
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: none;
    }
    
    .message.success {
      background: #dcfce7;
      color: #166534;
      border: 2px solid #bbf7d0;
      display: block;
    }
    
    .message.error {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #fecaca;
      display: block;
    }
    
    .message.info {
      background: #dbeafe;
      color: #1e40af;
      border: 2px solid #bfdbfe;
      display: block;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .code-block {
      background: #1f2937;
      color: #f9fafb;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      overflow-x: auto;
      margin: 8px 0;
    }
    
    @media (max-width: 640px) {
      body {
        padding: 12px;
      }
      
      .container {
        border-radius: 12px;
      }
      
      .header {
        padding: 24px 20px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .content {
        padding: 24px 20px;
      }
      
      .btn {
        padding: 14px 16px;
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“‚ CPAåˆ·é¢˜åŠ©æ‰‹ - GitHubåŒæ­¥</h1>
      <p>é€šè¿‡GitHub Gistå®ç°çš„å…è´¹äº‘åŒæ­¥æ–¹æ¡ˆ</p>
    </div>
    
    <div class="content">
      <!-- æ¶ˆæ¯æç¤º -->
      <div class="message" id="message"></div>
      
      <div class="info-box">
        <h4>ğŸ”§ GitHubåŒæ­¥è¯´æ˜</h4>
        <p>GitHubåŒæ­¥ä½¿ç”¨GitHub Gistä½œä¸ºå…è´¹çš„äº‘å­˜å‚¨æœåŠ¡ã€‚è¿™æ˜¯ä¸€ä¸ªå®Œå…¨å…è´¹çš„æ–¹æ¡ˆï¼Œä½†éœ€è¦GitHubè´¦å·ï¼Œå¹¶ä¸”åŒæ­¥çš„æ•°æ®ä¼šå…¬å¼€ï¼ˆå»ºè®®ä½¿ç”¨ç§æœ‰Gistï¼‰ã€‚</p>
      </div>
      
      <div class="section">
        <div class="section-title">
          <i class="fa fa-cog"></i>
          GitHubé…ç½®
        </div>
        
        <div class="form-group">
          <label class="form-label">GitHubç”¨æˆ·å</label>
          <input type="text" class="form-input" id="githubUsername" placeholder="è¯·è¾“å…¥æ‚¨çš„GitHubç”¨æˆ·å">
        </div>
        
        <div class="form-group">
          <label class="form-label">GitHub Token (å¯é€‰ï¼Œç”¨äºç§æœ‰Gist)</label>
          <input type="password" class="form-input" id="githubToken" placeholder="è¯·è¾“å…¥GitHub Personal Access Token">
        </div>
        
        <div class="form-group">
          <label class="form-label">Gist ID (ç•™ç©ºå°†è‡ªåŠ¨åˆ›å»º)</label>
          <input type="text" class="form-input" id="gistId" placeholder="å·²æœ‰çš„Gist IDï¼ˆå¯é€‰ï¼‰">
        </div>
        
        <div class="button-group">
          <button class="btn btn-primary" onclick="saveGitHubConfig()">
            <i class="fa fa-save"></i>
            ä¿å­˜é…ç½®
          </button>
          <button class="btn btn-secondary" onclick="testGitHubConnection()">
            <i class="fa fa-wifi"></i>
            æµ‹è¯•è¿æ¥
          </button>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">
          <i class="fa fa-exchange"></i>
          åŒæ­¥æ“ä½œ
        </div>
        
        <div class="button-group">
          <button class="btn btn-success" onclick="uploadToGitHub()">
            <i class="fa fa-cloud-upload"></i>
            <span id="uploadButtonText">ğŸ“¤ ä¸Šä¼ åˆ°GitHub</span>
          </button>
          <button class="btn btn-primary" onclick="downloadFromGitHub()">
            <i class="fa fa-cloud-download"></i>
            <span id="downloadButtonText">ğŸ“¥ ä»GitHubä¸‹è½½</span>
          </button>
          <button class="btn btn-secondary" onclick="autoSyncGitHub()">
            <i class="fa fa-refresh"></i>
            <span id="autoSyncButtonText">ğŸ”„ è‡ªåŠ¨åŒæ­¥</span>
          </button>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">
          <i class="fa fa-tachometer"></i>
          åŒæ­¥çŠ¶æ€
        </div>
        
        <div class="status-card">
          <div class="status-item">
            <span class="status-label">é…ç½®çŠ¶æ€:</span>
            <span class="status-value" id="configStatus">æœªé…ç½®</span>
          </div>
          <div class="status-item">
            <span class="status-label">GistçŠ¶æ€:</span>
            <span class="status-value" id="gistStatus">æœªçŸ¥</span>
          </div>
          <div class="status-item">
            <span class="status-label">ä¸Šæ¬¡ä¸Šä¼ :</span>
            <span class="status-value" id="lastUpload">ä»æœª</span>
          </div>
          <div class="status-item">
            <span class="status-label">ä¸Šæ¬¡ä¸‹è½½:</span>
            <span class="status-value" id="lastDownload">ä»æœª</span>
          </div>
          <div class="status-item">
            <span class="status-label">åŒæ­¥çŠ¶æ€:</span>
            <span class="status-value" id="syncStatus">æœªåŒæ­¥</span>
          </div>
        </div>
        
        <div class="button-group" style="margin-top: 16px;">
          <button class="btn btn-secondary" onclick="checkGitHubStatus()">
            <i class="fa fa-refresh"></i>
            åˆ·æ–°çŠ¶æ€
          </button>
          <button class="btn btn-danger" onclick="clearGitHubConfig()">
            <i class="fa fa-trash"></i>
            æ¸…é™¤é…ç½®
          </button>
        </div>
      </div>
      
      <div class="info-box">
        <h4>ğŸ“– ä½¿ç”¨æŒ‡å—</h4>
        <p><strong>ç¬¬ä¸€æ­¥ï¼šè·å–GitHub Tokenï¼ˆæ¨èï¼‰</strong><br>
        1. ç™»å½•GitHub â†’ ç‚¹å‡»å¤´åƒ â†’ Settings<br>
        2. å·¦ä¾§èœå• â†’ Developer settings â†’ Personal access tokens<br>
        3. Generate new token â†’ å‹¾é€‰ "gist" æƒé™<br>
        4. å¤åˆ¶ç”Ÿæˆçš„Tokenï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼‰</p>
        
        <p><strong>ç¬¬äºŒæ­¥ï¼šé…ç½®åŒæ­¥</strong><br>
        1. å¡«å†™GitHubç”¨æˆ·å<br>
        2. ç²˜è´´GitHub Tokenï¼ˆå¯é€‰ï¼Œä½†å»ºè®®å¡«å†™ï¼‰<br>
        3. ç‚¹å‡»"ä¿å­˜é…ç½®"å’Œ"æµ‹è¯•è¿æ¥"</p>
        
        <p><strong>ç¬¬ä¸‰æ­¥ï¼šå¼€å§‹åŒæ­¥</strong><br>
        â€¢ ä¸Šä¼ ï¼šå°†æœ¬åœ°æ•°æ®å¤‡ä»½åˆ°GitHub Gist<br>
        â€¢ ä¸‹è½½ï¼šä»GitHub Gistæ¢å¤æ•°æ®<br>
        â€¢ è‡ªåŠ¨åŒæ­¥ï¼šæ™ºèƒ½åˆå¹¶æœ¬åœ°å’Œäº‘ç«¯æ•°æ®</p>
      </div>
    </div>
  </div>

  <script>
    let githubConfig = null;
    let githubSyncRecord = null;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadGitHubConfig();
      checkGitHubStatus();
      checkDataStatus();
    });

    /**
     * åŠ è½½GitHubé…ç½®
     */
    function loadGitHubConfig() {
      try {
        const config = JSON.parse(localStorage.getItem('cpa_github_config') || '{}');
        if (config.username) {
          document.getElementById('githubUsername').value = config.username;
          document.getElementById('githubToken').value = config.token || '';
          document.getElementById('gistId').value = config.gistId || '';
          
          githubConfig = config;
          
          document.getElementById('configStatus').textContent = 'å·²é…ç½®';
          document.getElementById('configStatus').className = 'status-value success';
        }
        
        // åŠ è½½åŒæ­¥è®°å½•
        githubSyncRecord = JSON.parse(localStorage.getItem('cpa_github_sync_record') || '{}');
      } catch (error) {
        console.error('åŠ è½½GitHubé…ç½®å¤±è´¥:', error);
      }
    }

    /**
     * ä¿å­˜GitHubé…ç½®
     */
    function saveGitHubConfig() {
      try {
        const username = document.getElementById('githubUsername').value.trim();
        const token = document.getElementById('githubToken').value.trim();
        const gistId = document.getElementById('gistId').value.trim();
        
        if (!username) {
          showMessage('è¯·è¾“å…¥GitHubç”¨æˆ·å', 'error');
          return;
        }
        
        const config = {
          username: username,
          token: token,
          gistId: gistId
        };
        
        localStorage.setItem('cpa_github_config', JSON.stringify(config));
        githubConfig = config;
        
        showMessage('âœ… GitHubé…ç½®ä¿å­˜æˆåŠŸ', 'success');
        document.getElementById('configStatus').textContent = 'å·²é…ç½®';
        document.getElementById('configStatus').className = 'status-value success';
        
      } catch (error) {
        console.error('ä¿å­˜GitHubé…ç½®å¤±è´¥:', error);
        showMessage('âŒ ä¿å­˜é…ç½®å¤±è´¥: ' + error.message, 'error');
      }
    }

    /**
     * æµ‹è¯•GitHubè¿æ¥
     */
    async function testGitHubConnection() {
      try {
        if (!githubConfig) {
          showMessage('è¯·å…ˆä¿å­˜é…ç½®', 'error');
          return;
        }
        
        const headers = {
          'Accept': 'application/vnd.github.v3+json'
        };
        
        if (githubConfig.token) {
          headers['Authorization'] = `token ${githubConfig.token}`;
        }
        
        const response = await fetch(`https://api.github.com/users/${githubConfig.username}`, {
          method: 'GET',
          headers: headers
        });
        
        if (response.ok) {
          const userData = await response.json();
          showMessage(`âœ… è¿æ¥æˆåŠŸï¼æ¬¢è¿ï¼Œ${userData.name || userData.login}`, 'success');
          
          // å¦‚æœé…ç½®äº†Gist IDï¼Œæ£€æŸ¥Gistæ˜¯å¦å­˜åœ¨
          if (githubConfig.gistId) {
            try {
              const gistResponse = await fetch(`https://api.github.com/gists/${githubConfig.gistId}`, {
                headers: headers
              });
              
              if (gistResponse.ok) {
                document.getElementById('gistStatus').textContent = 'å·²æ‰¾åˆ°';
                document.getElementById('gistStatus').className = 'status-value success';
              } else {
                document.getElementById('gistStatus').textContent = 'æœªæ‰¾åˆ°';
                document.getElementById('gistStatus').className = 'status-value warning';
              }
            } catch (error) {
              console.error('æ£€æŸ¥Gistå¤±è´¥:', error);
            }
          }
          
        } else {
          throw new Error(`GitHub APIé”™è¯¯: ${response.status}`);
        }
        
      } catch (error) {
        console.error('æµ‹è¯•è¿æ¥å¤±è´¥:', error);
        showMessage('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
      }
    }

    /**
     * ä¸Šä¼ æ•°æ®åˆ°GitHub Gist
     */
    async function uploadToGitHub() {
      try {
        if (!githubConfig) {
          showMessage('è¯·å…ˆå®ŒæˆGitHubé…ç½®', 'error');
          return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const originalText = document.getElementById('uploadButtonText').textContent;
        document.getElementById('uploadButtonText').innerHTML = '<div class="loading"></div>ä¸Šä¼ ä¸­...';
        
        // è·å–æœ¬åœ°æ•°æ®
        const appData = JSON.parse(localStorage.getItem('cpa_app_data') || '{}');
        
        if (!appData.questionBank || appData.questionBank.length === 0) {
          showMessage('æ²¡æœ‰å¯ä¸Šä¼ çš„æ•°æ®', 'error');
          document.getElementById('uploadButtonText').textContent = originalText;
          return;
        }
        
        // è½¬æ¢Setä¸ºæ•°ç»„ä»¥ä¾¿JSONåºåˆ—åŒ–
        const uploadData = JSON.parse(JSON.stringify(appData));
        if (uploadData.progress) {
          if (uploadData.progress.starred) {
            uploadData.progress.starred = Array.from(uploadData.progress.starred);
          }
          if (uploadData.progress.wrong) {
            uploadData.progress.wrong = Array.from(uploadData.progress.wrong);
          }
        }
        
        // æ·»åŠ åŒæ­¥ä¿¡æ¯
        uploadData.syncInfo = {
          version: '1.0',
          timestamp: new Date().toISOString(),
          source: 'cpa-quiz-app',
          syncType: 'github'
        };
        
        const dataStr = JSON.stringify(uploadData, null, 2);
        
        // GitHub APIé…ç½®
        const headers = {
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        };
        
        if (githubConfig.token) {
          headers['Authorization'] = `token ${githubConfig.token}`;
        }
        
        let response;
        
        if (githubConfig.gistId) {
          // æ›´æ–°ç°æœ‰Gist
          response = await fetch(`https://api.github.com/gists/${githubConfig.gistId}`, {
            method: 'PATCH',
            headers: headers,
            body: JSON.stringify({
              files: {
                'cpa-quiz-data.json': {
                  content: dataStr
                }
              }
            })
          });
        } else {
          // åˆ›å»ºæ–°Gist
          response = await fetch('https://api.github.com/gists', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              description: 'CPAåˆ·é¢˜åŠ©æ‰‹å­¦ä¹ æ•°æ®å¤‡ä»½',
              public: !githubConfig.token, // å¦‚æœæ²¡æœ‰tokenï¼Œåªèƒ½åˆ›å»ºå…¬å¼€Gist
              files: {
                'cpa-quiz-data.json': {
                  content: dataStr
                }
              }
            })
          });
        }
        
        if (!response.ok) {
          throw new Error(`GitHub APIé”™è¯¯: ${response.status}`);
        }
        
        const gistData = await response.json();
        
        // ä¿å­˜Gist ID
        if (!githubConfig.gistId) {
          githubConfig.gistId = gistData.id;
          localStorage.setItem('cpa_github_config', JSON.stringify(githubConfig));
          document.getElementById('gistId').value = gistData.id;
        }
        
        // æ›´æ–°åŒæ­¥è®°å½•
        githubSyncRecord = {
          lastUpload: new Date().toLocaleString(),
          lastDownload: githubSyncRecord?.lastDownload || 'ä»æœª',
          gistId: gistData.id,
          gistUrl: gistData.html_url,
          syncStatus: 'synced'
        };
        
        localStorage.setItem('cpa_github_sync_record', JSON.stringify(githubSyncRecord));
        
        showMessage(`âœ… æˆåŠŸä¸Šä¼  ${appData.questionBank.length} é“é¢˜ç›®åˆ°GitHub Gist`, 'success');
        checkGitHubStatus();
        
      } catch (error) {
        console.error('ä¸Šä¼ åˆ°GitHubå¤±è´¥:', error);
        let errorMsg = 'âŒ ä¸Šä¼ å¤±è´¥: ';
        
        if (error.message.includes('401')) {
          errorMsg += 'GitHub Tokenæ— æ•ˆæˆ–æƒé™ä¸è¶³';
        } else if (error.message.includes('403')) {
          errorMsg += 'APIé€Ÿç‡é™åˆ¶ï¼Œè¯·ç¨åå†è¯•';
        } else if (error.message.includes('404')) {
          errorMsg += 'Gistä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®';
        } else {
          errorMsg += error.message;
        }
        
        showMessage(errorMsg, 'error');
        
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        document.getElementById('uploadButtonText').textContent = 'ğŸ“¤ ä¸Šä¼ åˆ°GitHub';
      }
    }

    /**
     * ä»GitHub Gistä¸‹è½½æ•°æ®
     */
    async function downloadFromGitHub() {
      try {
        if (!githubConfig || !githubConfig.gistId) {
          showMessage('è¯·å…ˆå®ŒæˆGitHubé…ç½®å¹¶ä¸Šä¼ æ•°æ®', 'error');
          return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const originalText = document.getElementById('downloadButtonText').textContent;
        document.getElementById('downloadButtonText').innerHTML = '<div class="loading"></div>ä¸‹è½½ä¸­...';
        
        // GitHub APIé…ç½®
        const headers = {
          'Accept': 'application/vnd.github.v3+json'
        };
        
        if (githubConfig.token) {
          headers['Authorization'] = `token ${githubConfig.token}`;
        }
        
        const response = await fetch(`https://api.github.com/gists/${githubConfig.gistId}`, {
          method: 'GET',
          headers: headers
        });
        
        if (!response.ok) {
          throw new Error(`GitHub APIé”™è¯¯: ${response.status}`);
        }
        
        const gistData = await response.json();
        const fileContent = gistData.files['cpa-quiz-data.json']?.content;
        
        if (!fileContent) {
          throw new Error('Gistä¸­æ²¡æœ‰æ‰¾åˆ°cpa-quiz-data.jsonæ–‡ä»¶');
        }
        
        const cloudData = JSON.parse(fileContent);
        
        // éªŒè¯æ•°æ®æ ¼å¼
        if (!cloudData.questionBank || !Array.isArray(cloudData.questionBank)) {
          throw new Error('GitHubä¸­çš„æ•°æ®æ ¼å¼æ— æ•ˆ');
        }
        
        // è½¬æ¢æ•°ç»„å›Set
        if (cloudData.progress) {
          if (Array.isArray(cloudData.progress.starred)) {
            cloudData.progress.starred = new Set(cloudData.progress.starred);
          }
          if (Array.isArray(cloudData.progress.wrong)) {
            cloudData.progress.wrong = new Set(cloudData.progress.wrong);
          }
        }
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('cpa_app_data', JSON.stringify(cloudData));
        
        // æ›´æ–°åŒæ­¥è®°å½•
        githubSyncRecord.lastDownload = new Date().toLocaleString();
        githubSyncRecord.syncStatus = 'synced';
        localStorage.setItem('cpa_github_sync_record', JSON.stringify(githubSyncRecord));
        
        showMessage(`âœ… æˆåŠŸä»GitHubä¸‹è½½ ${cloudData.questionBank.length} é“é¢˜ç›®`, 'success');
        checkGitHubStatus();
        checkDataStatus();
        
        // æç¤ºç”¨æˆ·åˆ·æ–°é¡µé¢
        setTimeout(() => {
          if (confirm('æ•°æ®ä¸‹è½½æˆåŠŸï¼æ˜¯å¦ç°åœ¨æ‰“å¼€CPAåˆ·é¢˜åŠ©æ‰‹ï¼Ÿ')) {
            window.location.href = 'index.html';
          }
        }, 1500);
        
      } catch (error) {
        console.error('ä»GitHubä¸‹è½½å¤±è´¥:', error);
        let errorMsg = 'âŒ ä¸‹è½½å¤±è´¥: ';
        
        if (error.message.includes('401')) {
          errorMsg += 'GitHub Tokenæ— æ•ˆæˆ–æƒé™ä¸è¶³';
        } else if (error.message.includes('403')) {
          errorMsg += 'APIé€Ÿç‡é™åˆ¶ï¼Œè¯·ç¨åå†è¯•';
        } else if (error.message.includes('404')) {
          errorMsg += 'Gistä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®';
        } else {
          errorMsg += error.message;
        }
        
        showMessage(errorMsg, 'error');
        
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        document.getElementById('downloadButtonText').textContent = 'ğŸ“¥ ä»GitHubä¸‹è½½';
      }
    }

    /**
     * è‡ªåŠ¨åŒæ­¥GitHubæ•°æ®
     */
    async function autoSyncGitHub() {
      try {
        if (!githubConfig) {
          showMessage('è¯·å…ˆå®ŒæˆGitHubé…ç½®', 'error');
          return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const originalText = document.getElementById('autoSyncButtonText').textContent;
        document.getElementById('autoSyncButtonText').innerHTML = '<div class="loading"></div>åŒæ­¥ä¸­...';
        
        // è·å–æœ¬åœ°æ•°æ®
        const localData = JSON.parse(localStorage.getItem('cpa_app_data') || '{}');
        
        if (githubConfig.gistId) {
          try {
            // å°è¯•ä»GitHubè·å–æ•°æ®
            const headers = {
              'Accept': 'application/vnd.github.v3+json'
            };
            
            if (githubConfig.token) {
              headers['Authorization'] = `token ${githubConfig.token}`;
            }
            
            const response = await fetch(`https://api.github.com/gists/${githubConfig.gistId}`, {
              headers: headers
            });
            
            if (response.ok) {
              const gistData = await response.json();
              const fileContent = gistData.files['cpa-quiz-data.json']?.content;
              
              if (fileContent) {
                const cloudData = JSON.parse(fileContent);
                
                // è½¬æ¢æ•°ç»„å›Set
                if (cloudData.progress) {
                  if (Array.isArray(cloudData.progress.starred)) {
                    cloudData.progress.starred = new Set(cloudData.progress.starred);
                  }
                  if (Array.isArray(cloudData.progress.wrong)) {
                    cloudData.progress.wrong = new Set(cloudData.progress.wrong);
                  }
                }
                
                if (!localData.questionBank || localData.questionBank.length === 0) {
                  // æœ¬åœ°æ²¡æœ‰æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨GitHubæ•°æ®
                  localStorage.setItem('cpa_app_data', JSON.stringify(cloudData));
                  showMessage(`âœ… å·²ä»GitHubæ¢å¤ ${cloudData.questionBank.length} é“é¢˜ç›®`, 'success');
                } else {
                  // åˆå¹¶æ•°æ®
                  const mergedData = mergeData(localData, cloudData);
                  localStorage.setItem('cpa_app_data', JSON.stringify(mergedData));
                  
                  // ä¸Šä¼ åˆå¹¶åçš„æ•°æ®å›GitHub
                  await uploadToGitHub();
                  showMessage('âœ… æ•°æ®å·²æ™ºèƒ½åˆå¹¶å¹¶åŒæ­¥åˆ°GitHub', 'success');
                }
                
                // æ›´æ–°åŒæ­¥è®°å½•
                githubSyncRecord.lastDownload = new Date().toLocaleString();
                githubSyncRecord.syncStatus = 'synced';
                localStorage.setItem('cpa_github_sync_record', JSON.stringify(githubSyncRecord));
              } else {
                // GitHubä¸Šæ²¡æœ‰æ•°æ®æ–‡ä»¶ï¼Œä¸Šä¼ æœ¬åœ°æ•°æ®
                if (localData.questionBank && localData.questionBank.length > 0) {
                  await uploadToGitHub();
                  showMessage('âœ… GitHubä¸Šæ²¡æœ‰æ•°æ®ï¼Œå·²ä¸Šä¼ æœ¬åœ°æ•°æ®', 'success');
                } else {
                  showMessage('âŒ æœ¬åœ°å’ŒGitHubéƒ½æ²¡æœ‰æ•°æ®', 'error');
                }
              }
            } else {
              throw new Error(`GitHub APIé”™è¯¯: ${response.status}`);
            }
            
          } catch (error) {
            if (error.message.includes('404')) {
              // Gistä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„
              if (localData.questionBank && localData.questionBank.length > 0) {
                await uploadToGitHub();
                showMessage('âœ… GitHubä¸Šæ²¡æœ‰æ‰¾åˆ°æ•°æ®ï¼Œå·²åˆ›å»ºæ–°çš„Gist', 'success');
              } else {
                showMessage('âŒ æœ¬åœ°å’ŒGitHubéƒ½æ²¡æœ‰æ•°æ®', 'error');
              }
            } else {
              throw error;
            }
          }
        } else {
          // æ²¡æœ‰Gist IDï¼Œç›´æ¥ä¸Šä¼ 
          if (localData.questionBank && localData.questionBank.length > 0) {
            await uploadToGitHub();
            showMessage('âœ… é¦–æ¬¡åŒæ­¥ï¼Œå·²ä¸Šä¼ æ•°æ®åˆ°GitHub', 'success');
          } else {
            showMessage('âŒ æ²¡æœ‰å¯åŒæ­¥çš„æ•°æ®', 'error');
          }
        }
        
        checkGitHubStatus();
        checkDataStatus();
        
      } catch (error) {
        console.error('è‡ªåŠ¨åŒæ­¥å¤±è´¥:', error);
        showMessage('âŒ è‡ªåŠ¨åŒæ­¥å¤±è´¥: ' + error.message, 'error');
        
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        document.getElementById('autoSyncButtonText').textContent = 'ğŸ”„ è‡ªåŠ¨åŒæ­¥';
      }
    }

    /**
     * åˆå¹¶æ•°æ®
     */
    function mergeData(localData, cloudData) {
      const merged = JSON.parse(JSON.stringify(localData));
      
      // åˆå¹¶è¿›åº¦æ•°æ®
      if (!merged.progress) merged.progress = {};
      if (!merged.progress.answers) merged.progress.answers = {};
      if (!merged.progress.starred) merged.progress.starred = new Set();
      if (!merged.progress.wrong) merged.progress.wrong = new Set();
      if (!merged.progress.notes) merged.progress.notes = {};
      
      // åˆå¹¶ç­”æ¡ˆ
      if (cloudData.progress?.answers) {
        Object.keys(cloudData.progress.answers).forEach(key => {
          const localAnswer = merged.progress.answers[key];
          const cloudAnswer = cloudData.progress.answers[key];
          
          // å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œæˆ–è€…äº‘ç«¯çš„æ›´æ–°æ—¶é—´æ›´æ™šï¼Œä½¿ç”¨äº‘ç«¯æ•°æ®
          if (!localAnswer || new Date(cloudAnswer.timestamp) > new Date(localAnswer.timestamp)) {
            merged.progress.answers[key] = cloudAnswer;
          }
        });
      }
      
      // åˆå¹¶æ˜Ÿæ ‡
      if (cloudData.progress?.starred) {
        cloudData.progress.starred.forEach(qid => merged.progress.starred.add(qid));
      }
      
      // åˆå¹¶é”™é¢˜
      if (cloudData.progress?.wrong) {
        cloudData.progress.wrong.forEach(qid => merged.progress.wrong.add(qid));
      }
      
      // åˆå¹¶ç¬”è®°
      if (cloudData.progress?.notes) {
        Object.keys(cloudData.progress.notes).forEach(key => {
          const localNote = merged.progress.notes[key];
          const cloudNote = cloudData.progress.notes[key];
          
          if (!localNote || new Date(cloudNote.timestamp) > new Date(localNote.timestamp)) {
            merged.progress.notes[key] = cloudNote;
          }
        });
      }
      
      return merged;
    }

    /**
     * æ£€æŸ¥GitHubçŠ¶æ€
     */
    async function checkGitHubStatus() {
      try {
        if (githubSyncRecord) {
          document.getElementById('lastUpload').textContent = githubSyncRecord.lastUpload || 'ä»æœª';
          document.getElementById('lastDownload').textContent = githubSyncRecord.lastDownload || 'ä»æœª';
          
          if (githubSyncRecord.syncStatus === 'synced') {
            document.getElementById('syncStatus').textContent = 'å·²åŒæ­¥';
            document.getElementById('syncStatus').className = 'status-value success';
          } else {
            document.getElementById('syncStatus').textContent = 'æœªåŒæ­¥';
            document.getElementById('syncStatus').className = 'status-value warning';
          }
        }
        
        if (githubConfig && githubConfig.gistId) {
          document.getElementById('gistStatus').textContent = 'å·²é…ç½®';
          document.getElementById('gistStatus').className = 'status-value success';
          
          // å°è¯•æ£€æŸ¥Gistæ˜¯å¦å­˜åœ¨
          try {
            const headers = {
              'Accept': 'application/vnd.github.v3+json'
            };
            
            if (githubConfig.token) {
              headers['Authorization'] = `token ${githubConfig.token}`;
            }
            
            const response = await fetch(`https://api.github.com/gists/${githubConfig.gistId}`, {
              headers: headers
            });
            
            if (response.ok) {
              document.getElementById('gistStatus').textContent = 'æ­£å¸¸';
            } else {
              document.getElementById('gistStatus').textContent = 'æ— æ³•è®¿é—®';
              document.getElementById('gistStatus').className = 'status-value error';
            }
          } catch (error) {
            // å¿½ç•¥é”™è¯¯
          }
        } else {
          document.getElementById('gistStatus').textContent = 'æœªé…ç½®';
          document.getElementById('gistStatus').className = 'status-value warning';
        }
        
      } catch (error) {
        console.error('æ£€æŸ¥GitHubçŠ¶æ€å¤±è´¥:', error);
      }
    }

    /**
     * æ£€æŸ¥æœ¬åœ°æ•°æ®çŠ¶æ€
     */
    function checkDataStatus() {
      try {
        const appData = JSON.parse(localStorage.getItem('cpa_app_data') || '{}');
        
        if (appData.questionBank && appData.questionBank.length > 0) {
          // æ•°æ®çŠ¶æ€å·²åœ¨å…¶ä»–åŒæ­¥é¡µé¢æ˜¾ç¤ºï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„çŠ¶æ€æ˜¾ç¤º
        }
      } catch (error) {
        console.error('æ£€æŸ¥æ•°æ®çŠ¶æ€å¤±è´¥:', error);
      }
    }

    /**
     * æ¸…é™¤GitHubé…ç½®
     */
    function clearGitHubConfig() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤GitHubé…ç½®å—ï¼Ÿè¿™ä¸ä¼šåˆ é™¤GitHubä¸Šçš„æ•°æ®ã€‚')) {
        localStorage.removeItem('cpa_github_config');
        localStorage.removeItem('cpa_github_sync_record');
        
        githubConfig = null;
        githubSyncRecord = null;
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('githubUsername').value = '';
        document.getElementById('githubToken').value = '';
        document.getElementById('gistId').value = '';
        
        showMessage('âœ… GitHubé…ç½®å·²æ¸…é™¤', 'success');
        
        // é‡ç½®çŠ¶æ€æ˜¾ç¤º
        document.getElementById('configStatus').textContent = 'æœªé…ç½®';
        document.getElementById('configStatus').className = 'status-value warning';
        document.getElementById('gistStatus').textContent = 'æœªçŸ¥';
        document.getElementById('gistStatus').className = 'status-value warning';
        document.getElementById('lastUpload').textContent = 'ä»æœª';
        document.getElementById('lastDownload').textContent = 'ä»æœª';
        document.getElementById('syncStatus').textContent = 'æœªåŒæ­¥';
        document.getElementById('syncStatus').className = 'status-value warning';
      }
    }

    /**
     * æ˜¾ç¤ºæ¶ˆæ¯
     */
    function showMessage(text, type = 'info') {
      const message = document.getElementById('message');
      message.textContent = text;
      message.className = `message ${type}`;
      
      // 3ç§’åè‡ªåŠ¨éšè—
      if (type !== 'error') {
        setTimeout(() => {
          message.style.display = 'none';
        }, 3000);
      }
    }
  </script>
</body>
</html>